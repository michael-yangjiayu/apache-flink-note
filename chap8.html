
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>8. 读写外部系统 · 基于 Apache Flink 的流处理</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="杨镓毓">
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="chap9.html" />
    
    
    <link rel="prev" href="chap7.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    0. 简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="chap1.html">
            
                <a href="chap1.html">
            
                    
                    1. 状态化流处理概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="chap2.html">
            
                <a href="chap2.html">
            
                    
                    2. 流处理基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="chap3.html">
            
                <a href="chap3.html">
            
                    
                    3. Apache Flink 架构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="chap4.html">
            
                <a href="chap4.html">
            
                    
                    4. 设置 Apache Flink 开发环境
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="chap5.html">
            
                <a href="chap5.html">
            
                    
                    5. DataStream API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="chap6.html">
            
                <a href="chap6.html">
            
                    
                    6. 基于时间和窗口的算子
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="chap7.html">
            
                <a href="chap7.html">
            
                    
                    7. 有状态算子和应用
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.9" data-path="chap8.html">
            
                <a href="chap8.html">
            
                    
                    8. 读写外部系统
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="chap9.html">
            
                <a href="chap9.html">
            
                    
                    9. 搭建 Flink 运行流式应用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="chap10.html">
            
                <a href="chap10.html">
            
                    
                    10. Flink 和流式应用运维
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12" data-path="chap11.html">
            
                <a href="chap11.html">
            
                    
                    11. 还有什么？
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >8. 读写外部系统</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="8-&#x8BFB;&#x5199;&#x5916;&#x90E8;&#x7CFB;&#x7EDF;">8. &#x8BFB;&#x5199;&#x5916;&#x90E8;&#x7CFB;&#x7EDF;</h1>
<h2 id="&#x5E94;&#x7528;&#x7684;&#x4E00;&#x81F4;&#x6027;&#x4FDD;&#x969C;">&#x5E94;&#x7528;&#x7684;&#x4E00;&#x81F4;&#x6027;&#x4FDD;&#x969C;</h2>
<ul>
<li><strong>&#x6570;&#x636E;&#x6E90;&#x8FDE;&#x63A5;&#x5668;</strong><ul>
<li>&#x57FA;&#x4E8E;&#x6587;&#x4EF6;&#x7684;&#x8FDE;&#x63A5;&#x5668;&#xFF08;&#x6587;&#x4EF6;&#x5B57;&#x8282;&#x6D41;&#x7684;&#x8BFB;&#x53D6;&#x504F;&#x79FB;&#xFF09;</li>
<li>Kafka&#x8FDE;&#x63A5;&#x5668;&#xFF08;&#x6D88;&#x8D39;topic&#x5206;&#x533A;&#x7684;&#x8BFB;&#x53D6;&#x504F;&#x79FB;&#xFF09;</li>
</ul>
</li>
<li><strong>&#x6570;&#x636E;&#x6C47;&#x8FDE;&#x63A5;&#x5668;</strong><ul>
<li>&#x5E42;&#x7B49;&#x6027;&#x5199;&#xFF1A;&#x6545;&#x969C;&#x6062;&#x590D;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x4E34;&#x65F6;&#x6027;&#x4E0D;&#x4E00;&#x81F4;&#xFF08;e.g. &#x5C06;&#x76F8;&#x540C;&#x7684;&#x952E;&#x503C;&#x5BF9;&#x63D2;&#x5165;HashMap&#xFF09;</li>
<li>&#x4E8B;&#x52A1;&#x6027;&#x5199;&#xFF1A;&#x53EA;&#x6709;&#x5728;&#x4E0A;&#x6B21;&#x6210;&#x529F;&#x7684;&#x68C0;&#x67E5;&#x70B9;&#x4E4B;&#x524D;&#x8BA1;&#x7B97;&#x7684;&#x7ED3;&#x679C;&#x624D;&#x88AB;&#x5199;&#x5165;&#xFF08;&#x5EF6;&#x8FDF;&#xFF09;</li>
<li>WAL &#x6570;&#x636E;&#x6C47;&#xFF08;write-ahead log&#xFF09;&#xFF1A;&#x5C06;&#x6240;&#x6709;&#x7ED3;&#x679C;&#x8BB0;&#x5F55;&#x5199;&#x5165;&#x5E94;&#x7528;&#x72B6;&#x6001;&#xFF0C;&#x5E76;&#x5728;&#x68C0;&#x67E5;&#x70B9;&#x5B8C;&#x6210;&#x540E;&#x53D1;&#x9001;</li>
<li>2PC &#x6570;&#x636E;&#x6C47;&#xFF08;two-phase commit&#xFF09;&#xFF1A;&#x6536;&#x5230;&#x68C0;&#x67E5;&#x70B9;&#x5B8C;&#x6210;&#x901A;&#x77E5;&#x540E;&#xFF0C;&#x63D0;&#x4EA4;&#x4E8B;&#x52A1;&#x771F;&#x6B63;&#x5199;&#x5165;&#x7ED3;&#x679C;</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>&#x4E0D;&#x53EF;&#x91CD;&#x7F6E;&#x6570;&#x636E;&#x6E90;</th>
<th>&#x53EF;&#x91CD;&#x7F6E;&#x6570;&#x636E;&#x6E90;</th>
</tr>
</thead>
<tbody>
<tr>
<td>&#x4EFB;&#x610F;&#x6570;&#x636E;&#x6C47;</td>
<td>&#x81F3;&#x591A;&#x4E00;&#x6B21;</td>
<td>&#x81F3;&#x5C11;&#x4E00;&#x6B21;</td>
</tr>
<tr>
<td>&#x5E42;&#x7B49;&#x6027;&#x6570;&#x636E;&#x6C47;</td>
<td>&#x81F3;&#x591A;&#x4E00;&#x6B21;</td>
<td>&#x7CBE;&#x786E;&#x4E00;&#x6B21;</td>
</tr>
<tr>
<td>WAL &#x6570;&#x636E;&#x6C47;</td>
<td>&#x81F3;&#x591A;&#x4E00;&#x6B21;</td>
<td>&#x81F3;&#x5C11;&#x4E00;&#x6B21;</td>
</tr>
<tr>
<td>2PC &#x6570;&#x636E;&#x6C47;</td>
<td>&#x81F3;&#x591A;&#x4E00;&#x6B21;</td>
<td>&#x7CBE;&#x786E;&#x4E00;&#x6B21;</td>
</tr>
</tbody>
</table>
<h2 id="&#x5185;&#x7F6E;&#x8FDE;&#x63A5;&#x5668;">&#x5185;&#x7F6E;&#x8FDE;&#x63A5;&#x5668;</h2>
<h3 id="kafka-&#x6570;&#x636E;&#x6E90;">Kafka &#x6570;&#x636E;&#x6E90;</h3>
<pre><code class="lang-scala"><span class="hljs-comment">// org.apache.flink.flink-connector-kafka_2.12 (v1.7.1)</span>
<span class="hljs-keyword">val</span> properties = <span class="hljs-keyword">new</span> <span class="hljs-type">Properties</span>()
properties.setProperty(<span class="hljs-string">&quot;bootstraip.servers&quot;</span>, <span class="hljs-string">&quot;localhost:9092&quot;</span>)
properties.setProperty(<span class="hljs-string">&quot;group.id&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>)

<span class="hljs-keyword">val</span> stream: <span class="hljs-type">DataStream</span>[<span class="hljs-type">String</span>] = env.addSource(
    <span class="hljs-keyword">new</span> <span class="hljs-type">FlinkKafkaConsumer</span>[<span class="hljs-type">String</span>](
        <span class="hljs-string">&quot;topic&quot;</span>,                      <span class="hljs-comment">// topic: &#x5355;&#x4E2A;/&#x5217;&#x8868;/&#x6B63;&#x5219;&#x8868;&#x8FBE;&#x5F0F;</span>
        <span class="hljs-keyword">new</span> <span class="hljs-type">SimpleStringSchema</span>(),     <span class="hljs-comment">// (Keyed)DeserializationSchema</span>
        properties))                  <span class="hljs-comment">// properties</span>

<span class="hljs-type">FlinkKafkaConsumer</span>.assignTimestampAndWatermark()        <span class="hljs-comment">// &#x65F6;&#x95F4;&#x6233;&#x3001;&#x6C34;&#x4F4D;&#x7EBF;</span>
    - <span class="hljs-type">AssignerWithPeriodicWatermark</span>
    - <span class="hljs-type">AssignerWithPunctuatedWatermark</span>

<span class="hljs-type">FlinkKafkaConsumer</span>.setStartFromGroupoffsets()           <span class="hljs-comment">// &#x6700;&#x540E;&#x8BFB;&#x53D6;&#x4F4D;&#x7F6E;&#xFF08;group.id&#xFF09;</span>
<span class="hljs-type">FlinkKafkaConsumer</span>.setStartFromEarliest()               <span class="hljs-comment">// &#x6BCF;&#x4E2A;&#x5206;&#x533A;&#x6700;&#x65E9;&#x7684;&#x504F;&#x79FB;</span>
<span class="hljs-type">FlinkKafkaConsumer</span>.setStartFromLatest()                 <span class="hljs-comment">// &#x6BCF;&#x4E2A;&#x5206;&#x533A;&#x6700;&#x665A;&#x7684;&#x504F;&#x79FB;</span>
<span class="hljs-type">FlinkKafkaConsumer</span>.setStartFromTimestamp(long)          <span class="hljs-comment">// &#x65F6;&#x95F4;&#x6233;&#x5927;&#x4E8E;&#x7ED9;&#x5B9A;&#x503C;&#x7684;&#x8BB0;&#x5F55;</span>
<span class="hljs-type">FlinkKafkaConsumer</span>.setStartFromSpeecificOffsets(<span class="hljs-type">Map</span>)    <span class="hljs-comment">// &#x4E3A;&#x6240;&#x6709;&#x5206;&#x533A;&#x6307;&#x5B9A;&#x8BFB;&#x53D6;&#x4F4D;&#x7F6E;</span>

<span class="hljs-comment">// &#x81EA;&#x52A8;&#x53D1;&#x73B0;&#x6EE1;&#x8DB3;&#x6B63;&#x5219;&#x8868;&#x8FBE;&#x5F0F;&#x7684;&#x65B0;&#x4E3B;&#x9898;</span>
<span class="hljs-comment">// properties.setProperty(&quot;flink.partition-discorvery.interval-millis&quot;, &quot;1000&quot;)</span>
</code></pre>
<h3 id="kafka-&#x6570;&#x636E;&#x6C47;">Kafka &#x6570;&#x636E;&#x6C47;</h3>
<pre><code class="lang-scala"><span class="hljs-comment">// org.apache.flink.flink-connector-kafka_2.12 (v1.7.1)</span>
<span class="hljs-keyword">val</span> stream: <span class="hljs-type">DataStream</span>[<span class="hljs-type">String</span>] = ...
<span class="hljs-keyword">val</span> myProducer = <span class="hljs-keyword">new</span> <span class="hljs-type">FlinkKafkaProducer</span>[<span class="hljs-type">String</span>](
    <span class="hljs-string">&quot;localhost:9092&quot;</span>,        <span class="hljs-comment">// Kafka Broker &#x5217;&#x8868; (,)</span>
    <span class="hljs-string">&quot;topic&quot;</span>,                 <span class="hljs-comment">// &#x76EE;&#x6807; topic</span>
    <span class="hljs-keyword">new</span> <span class="hljs-type">SimpleStringSchema</span>)  <span class="hljs-comment">// &#x5E8F;&#x5217;&#x5316;&#x7684; Schema</span>
stream.addSink(myProducer)
</code></pre>
<ul>
<li><strong>&#x81F3;&#x5C11;&#x4E00;&#x6B21;&#x4FDD;&#x969C;</strong><ul>
<li>Flink&#x68C0;&#x67E5;&#x70B9;&#x5F00;&#x542F;&#xFF0C;&#x4E14;&#x6240;&#x6709;&#x6570;&#x636E;&#x6E90;&#x53EF;&#x91CD;&#x7F6E;</li>
<li>&#x5982;&#x679C;&#x6570;&#x636E;&#x6C47;&#x8FDE;&#x63A5;&#x5668;&#x5199;&#x5165;&#x4E0D;&#x6210;&#x529F;&#xFF0C;&#x5219;&#x4F1A;&#x629B;&#x51FA;&#x5F02;&#x5E38;&#xFF08;default&#xFF09;</li>
<li>&#x6570;&#x636E;&#x6C47;&#x8FDE;&#x63A5;&#x5668;&#x8981;&#x5728;&#x68C0;&#x67E5;&#x70B9;&#x5B8C;&#x6210;&#x524D;&#x7B49;&#x5F85;Kafka&#x786E;&#x8BA4;&#x5199;&#x5165;&#x5B8C;&#x6BD5;&#xFF08;default&#xFF09;</li>
</ul>
</li>
<li><strong>&#x7CBE;&#x786E;&#x4E00;&#x6B21;&#x4FDD;&#x969C;</strong>&#xFF08;v0.11&#xFF09;<ul>
<li>Semantic.NONE</li>
<li>Semantic.AT_LEAST_ONCE (default)</li>
<li>Semantic.EXACTLY_ONCE&#xFF1A;&#x5168;&#x90E8;&#x6D88;&#x606F;&#x8FFD;&#x52A0;&#x5230;&#x5206;&#x533A;&#x65E5;&#x5FD7;&#xFF0C; &#x5E76;&#x5728;&#x4E8B;&#x52A1;&#x63D0;&#x4EA4;&#x540E;&#x6807;&#x8BB0;&#x4E3A;&#x5DF2;&#x63D0;&#x4EA4;&#xFF08;&#x5EF6;&#x8FDF;&#xFF09;</li>
</ul>
</li>
<li><strong>&#x81EA;&#x5B9A;&#x4E49;&#x5206;&#x533A;&#x548C;&#x5199;&#x5165;&#x6D88;&#x606F;&#x65F6;&#x95F4;&#x6233;</strong><ul>
<li>&#x81EA;&#x5B9A;&#x4E49;&#x5206;&#x533A;&#xFF1A;&#x63D0;&#x4F9B; KeyedSerializationSchema&#xFF0C;FlinkKafkaPartitioner=null &#x7981;&#x7528;&#x9ED8;&#x8BA4;&#x5206;&#x533A;&#x5668;</li>
<li>&#x5199;&#x5165;&#x65F6;&#x95F4;&#x6233;&#xFF08;v0.10&#xFF09;&#xFF1A;setWriteTimestamp ToKafka(true)</li>
</ul>
</li>
</ul>
<h3 id="&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x6570;&#x636E;&#x6E90;">&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x6570;&#x636E;&#x6E90;</h3>
<pre><code class="lang-scala"><span class="hljs-keyword">val</span> lineReader = <span class="hljs-keyword">new</span> <span class="hljs-type">TextInputFormat</span>(<span class="hljs-literal">null</span>)
<span class="hljs-keyword">val</span> lineStream: <span class="hljs-type">DataStream</span>[<span class="hljs-type">String</span>] = env.readFile[<span class="hljs-type">String</span>](
    lineReader,                                  <span class="hljs-comment">// FileInputFormat</span>
    <span class="hljs-string">&quot;hdfs:///path/to/my/data&quot;</span>,                   <span class="hljs-comment">// &#x8BFB;&#x53D6;&#x8DEF;&#x5F84;</span>
    <span class="hljs-type">FileProcessing</span>.<span class="hljs-type">Mode</span>.<span class="hljs-type">PROCESS_CONTINUOUSLY</span>,    <span class="hljs-comment">// &#x5904;&#x7406;&#x6A21;&#x5F0F;&#xFF0C;&#x6216; PROCESS_ONCE</span>
    <span class="hljs-number">30000</span>L)                                      <span class="hljs-comment">// &#x76D1;&#x63A7;&#x95F4;&#x9694;&#xFF08;ms&#xFF09;</span>
</code></pre>
<h3 id="&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x6570;&#x636E;&#x6C47;">&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x6570;&#x636E;&#x6C47;</h3>
<pre><code class="lang-scala"><span class="hljs-keyword">val</span> input: <span class="hljs-type">DataStream</span>[<span class="hljs-type">String</span>] = ...
<span class="hljs-keyword">val</span> sink: <span class="hljs-type">StreamingFileSink</span>[<span class="hljs-type">String</span>] = <span class="hljs-type">StreamingFileSink</span>
    .forRowFormat(                                <span class="hljs-comment">// &#x884C;&#x7F16;&#x7801;</span>
        <span class="hljs-keyword">new</span> <span class="hljs-type">Path</span>(<span class="hljs-string">&quot;/base/path&quot;</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-type">SimpleStringEncoder</span>[<span class="hljs-type">String</span>](<span class="hljs-string">&quot;UTF-8&quot;</span>))
    .build()
input.addSink(sink)
</code></pre>
<ul>
<li><strong>&#x6876;&#x7684;&#x9009;&#x62E9;</strong> <code>BucketAssigner</code> (default = <code>DataTimeBucketAssigner</code>)<ul>
<li>&#x8DEF;&#x5F84;&#x89C4;&#x5219;&#xFF1A;[base-path]/[bucket-part]]/part-[task-idx]-[id]</li>
<li>RollingPolicy&#xFF1A;&#x4F55;&#x65F6;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x5206;&#x5757;&#x6587;&#x4EF6;&#xFF08;&#x9ED8;&#x8BA4;&#x6587;&#x4EF6;&#x5927;&#x5C0F;&#x8D85;&#x8FC7;128M&#x6216;&#x4E8B;&#x4EF6;&#x8D85;&#x8FC7;60&#x79D2;&#xFF09;</li>
</ul>
</li>
<li><strong>&#x4E24;&#x79CD;&#x5206;&#x5757;&#x6587;&#x4EF6;&#x5199;&#x5165;&#x6A21;&#x5F0F;</strong><ul>
<li>&#x884C;&#x7F16;&#x7801;&#xFF08;row encoding&#xFF09;&#xFF1A;&#x5C06;&#x6BCF;&#x6761;&#x8BB0;&#x5F55;&#x5355;&#x72EC;&#x5199;&#x5165;&#x5206;&#x5757;&#x6587;&#x4EF6;&#x4E2D;&#xFF08;SimpleStringEncoder&#xFF09;</li>
<li>&#x6279;&#x91CF;&#x7F16;&#x7801;&#xFF08;bulk encoding&#xFF09;&#xFF1A;&#x8BB0;&#x5F55;&#x4F1A;&#x88AB;&#x6512;&#x6210;&#x6279;&#xFF0C;&#x7136;&#x540E;&#x4E00;&#x6B21;&#x6027;&#x5199;&#x5165;&#xFF0C;&#x5982;&#x679C; Apache Parquet</li>
</ul>
</li>
</ul>
<pre><code class="lang-scala"><span class="hljs-keyword">val</span> input: <span class="hljs-type">DataStream</span>[<span class="hljs-type">String</span>] = ...
<span class="hljs-keyword">val</span> sink: <span class="hljs-type">StreamingFileSink</span>[<span class="hljs-type">String</span>] = <span class="hljs-type">StreamingFileSink</span>
    .forBulkFormat(                                <span class="hljs-comment">// &#x6279;&#x91CF;&#x7F16;&#x7801;</span>
        <span class="hljs-keyword">new</span> <span class="hljs-type">Path</span>(<span class="hljs-string">&quot;/base/path&quot;</span>),
        <span class="hljs-type">ParquetAvroWriter</span>.forSpecificRecord(classof[<span class="hljs-type">AvroPojo</span>]))
    .build()
input.addSink(sink)
</code></pre>
<h3 id="cassandra-&#x6570;&#x636E;&#x6C47;">Cassandra &#x6570;&#x636E;&#x6C47;</h3>
<ul>
<li><strong>&#x9488;&#x5BF9;&#x5143;&#x7EC4;</strong></li>
</ul>
<pre><code class="lang-scala"><span class="hljs-comment">// org.apache.flink.flink-connector-cassandra_2.12 (v1.7.1)</span>
<span class="hljs-comment">// &#x5B9A;&#x4E49; Cassandra &#x793A;&#x4F8B;&#x8868;</span>
<span class="hljs-type">CREATE</span> <span class="hljs-type">KEYSPACE</span> <span class="hljs-type">IF</span> <span class="hljs-type">NOT</span> <span class="hljs-type">EXISTS</span> example
    <span class="hljs-type">WITH</span> replication = {<span class="hljs-symbol">&apos;clas</span>s&apos;: <span class="hljs-symbol">&apos;SimpleStrateg</span>y&apos;, <span class="hljs-symbol">&apos;replication_facto</span>r&apos;: &apos;<span class="hljs-number">1</span>&apos;};
<span class="hljs-type">CREATE</span> <span class="hljs-type">TABLE</span> <span class="hljs-type">IF</span> <span class="hljs-type">NOT</span> <span class="hljs-type">EXISTS</span> example.sensors (
    sensord <span class="hljs-type">VARCHAR</span>,
    temperature <span class="hljs-type">FLOAT</span>,
    <span class="hljs-type">PRIMARY</span> <span class="hljs-type">KEY</span>(sensorId)
);

<span class="hljs-comment">// &#x9488;&#x5BF9;&#x5143;&#x7EC4;&#x7684; Cassandra &#x6570;&#x636E;&#x6C47;</span>
<span class="hljs-keyword">val</span> readings: <span class="hljs-type">DataStream</span>[(<span class="hljs-type">String</span>, <span class="hljs-type">Float</span>)] = ...
<span class="hljs-keyword">val</span> sinkBuilder: <span class="hljs-type">CassandraSinkBuilder</span>[(<span class="hljs-type">String</span>, <span class="hljs-type">Float</span>)] =
    <span class="hljs-type">CassandraSink</span>.addSink(readings)
sinkBuilder.setHost(<span class="hljs-string">&quot;localhost&quot;</span>).setQuery(
    <span class="hljs-string">&quot;INSERT INTO example.sensor(sensorId, temperature) VALUES (?, ?);&quot;</span>)
    .build()
</code></pre>
<ul>
<li><strong>&#x9488;&#x5BF9; POJO &#x7C7B;&#x578B;</strong></li>
</ul>
<pre><code class="lang-scala">// &#x9488;&#x5BF9; POJO &#x7C7B;&#x578B;&#x521B;&#x5EFA; Cassandra &#x6570;&#x636E;&#x6C47;
val readings: DataStream[(String, Float)] = ...
CassandraSink.addSink(readings).setHost(&quot;localhost&quot;).build()

// &#x6DFB;&#x52A0;&#x4E86; Cassandra Object Mapper &#x6CE8;&#x91CA;&#x7684; POJO &#x7C7B;
@Table(keyspace = &quot;example&quot;, name = &quot;sensors&quot;)
class SensorReading(
    @Column(name = &quot;sensorId&quot;) var id: String,
    @Column(name = &quot;temporature) var temp: Float) {

    def this() = this(&quot;&quot;, 0.0)
    def setId(id: String): Unit = this.id = id
    def getid: String = id
    def setTemp(temp: Float): Unit = this.temp = temp
    def getTemp: Float = temp
}
</code></pre>
<ul>
<li>setClusterBuilder(ClusterBuilder)&#xFF1A;&#x7BA1;&#x7406;&#x548C; Cassandra &#x7684;&#x8FDE;&#x63A5;</li>
<li>setHost(String, [Int])</li>
<li>setQuery(String)</li>
<li>setMapperOptions(MapperOptions)</li>
<li>enableWriteAheadLog([CheckpointCommiter])&#xFF1A;&#x5F00;&#x542F; WAL&#xFF0C;&#x63D0;&#x4F9B;&#x7CBE;&#x786E;&#x4E00;&#x6B21;&#x8F93;&#x51FA;&#x4FDD;&#x969C;</li>
</ul>
<h2 id="&#x5B9E;&#x73B0;&#x81EA;&#x5B9A;&#x4E49;&#x6570;&#x636E;&#x6E90;&#x51FD;&#x6570;">&#x5B9E;&#x73B0;&#x81EA;&#x5B9A;&#x4E49;&#x6570;&#x636E;&#x6E90;&#x51FD;&#x6570;</h2>
<ul>
<li>SourceFunction &#x548C; RichSourceFunction&#xFF1A;&#x5B9A;&#x4E49;&#x975E;&#x5E76;&#x884C;&#x7684;&#x6570;&#x636E;&#x6E90;&#x8FDE;&#x63A5;&#x5668;&#xFF08;&#x5355;&#x4EFB;&#x52A1;&#x8FD0;&#x884C;&#xFF09;</li>
<li>ParallelSourceFunction &#x548C; ParallelRichSourceFunction&#xFF1A;&#x5B9A;&#x4E49;&#x5E76;&#x884C;&#x7684;&#x6570;&#x636E;&#x6E90;&#x8FDE;&#x63A5;&#x8D77;</li>
<li>(Parallel)SourceFunction&#xFF1A;run() &#x6267;&#x884C;&#x8BB0;&#x5F55;&#x8BFB;&#x5165;&#xFF0C;cancel() &#x5728;&#x53D6;&#x6D88;&#x6216;&#x5173;&#x95ED;&#x65F6;&#x8C03;&#x7528;</li>
<li><strong>&#x53EF;&#x91CD;&#x7F6E;&#x7684;&#x6570;&#x636E;&#x6E90;&#x51FD;&#x6570;</strong><ul>
<li>&#x5B9E;&#x73B0; CheckpointedFunction &#x63A5;&#x53E3;&#xFF0C;&#x5E76;&#x628A;&#x8BFB;&#x53D6;&#x504F;&#x79FB;&#x548C;&#x76F8;&#x5173;&#x5143;&#x6570;&#x636E;&#x4FE1;&#x606F;&#x5B58;&#x5165;&#x72B6;&#x6001;</li>
<li>run() &#x4E0D;&#x4F1A;&#x518D;&#x68C0;&#x67E5;&#x70B9;&#x751F;&#x6210;&#x8FC7;&#x7A0B;&#x4E2D;&#x63A8;&#x8FDB;&#x504F;&#x79FB;/&#x53D1;&#x51FA;&#x6570;&#x636E;&#xFF1A;SourceContext.getCheckpointLock()</li>
</ul>
</li>
<li><p><strong>&#x6570;&#x636E;&#x6E90;&#x51FD;&#x6570;&#x3001;&#x65F6;&#x95F4;&#x6233;&#x53CA;&#x6C34;&#x4F4D;&#x7EBF;</strong></p>
<ul>
<li>SourceContext<ul>
<li>collectWithTimestamp(record: T, timestamp: Long): Unit</li>
<li>def emitWatermark(watermark: Watermark): Unit</li>
</ul>
</li>
<li>&#x6807;&#x8BB0;&#x4E3A;&#x6682;&#x65F6;&#x7A7A;&#x95F2;&#xFF1A;SourceContext.markAsTemporarilyIdle()</li>
</ul>
</li>
<li><p><strong>SourceFunction</strong></p>
</li>
</ul>
<pre><code class="lang-scala"><span class="hljs-comment">// &#x4ECE; 0 &#x6570;&#x5230; LongMaxValue &#x7684; SourceFunction</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SourceFunction</span>[<span class="hljs-type">Long</span>] </span>{
  <span class="hljs-keyword">var</span> isRunning: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">true</span>

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span></span>(ctx: <span class="hljs-type">SourceFunction</span>.<span class="hljs-type">SourceContext</span>[<span class="hljs-type">Long</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">var</span> cnt: <span class="hljs-type">Long</span> = <span class="hljs-number">-1</span>
    <span class="hljs-keyword">while</span> (isRunning &amp;&amp; cnt &lt; <span class="hljs-type">Long</span>.<span class="hljs-type">MaxValue</span>) {
      <span class="hljs-comment">// increment cnt</span>
      cnt += <span class="hljs-number">1</span>
      ctx.collect(cnt)
    }
  }

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cancel</span></span>(): <span class="hljs-type">Unit</span> = isRunning = <span class="hljs-literal">false</span>
}
</code></pre>
<ul>
<li><strong>&#x53EF;&#x91CD;&#x7F6E;&#x7684; SourceFunction</strong></li>
</ul>
<pre><code class="lang-scala"><span class="hljs-comment">// &#x53EF;&#x91CD;&#x7F6E;&#x7684; SourceFunction</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReplayableCountSource</span></span>
    <span class="hljs-keyword">extends</span> <span class="hljs-type">SourceFunction</span>[<span class="hljs-type">Long</span>] <span class="hljs-keyword">with</span> <span class="hljs-type">CheckpointedFunction</span> {

  <span class="hljs-keyword">var</span> isRunning: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">var</span> cnt: <span class="hljs-type">Long</span> = _
  <span class="hljs-keyword">var</span> offsetState: <span class="hljs-type">ListState</span>[<span class="hljs-type">Long</span>] = _

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span></span>(ctx: <span class="hljs-type">SourceFunction</span>.<span class="hljs-type">SourceContext</span>[<span class="hljs-type">Long</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">while</span> (isRunning &amp;&amp; cnt &lt; <span class="hljs-type">Long</span>.<span class="hljs-type">MaxValue</span>) {
      ctx.getCheckpointLock.synchronized {
        <span class="hljs-comment">// increment cnt</span>
        cnt += <span class="hljs-number">1</span>
        ctx.collect(cnt)
      }
    }
  }

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">cancel</span></span>(): <span class="hljs-type">Unit</span> = isRunning = <span class="hljs-literal">false</span>

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">snapshotState</span></span>(snapshotCtx: <span class="hljs-type">FunctionSnapshotContext</span>): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// remove previous cnt</span>
    offsetState.clear()
    <span class="hljs-comment">// add current cnt</span>
    offsetState.add(cnt)
  }

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">initializeState</span></span>(initCtx: <span class="hljs-type">FunctionInitializationContext</span>): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// obtain operator list state to store the current cnt</span>
    <span class="hljs-keyword">val</span> desc = <span class="hljs-keyword">new</span> <span class="hljs-type">ListStateDescriptor</span>[<span class="hljs-type">Long</span>](<span class="hljs-string">&quot;offset&quot;</span>, classOf[<span class="hljs-type">Long</span>])
    offsetState = initCtx.getOperatorStateStore.getListState(desc)
    <span class="hljs-comment">// initialize cnt variable from the checkpoint</span>
    <span class="hljs-keyword">val</span> it = offsetState.get()
    cnt = <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == it || !it.iterator().hasNext) {
      <span class="hljs-number">-1</span>L
    } <span class="hljs-keyword">else</span> {
      it.iterator().next()
    }
  }
}
</code></pre>
<h2 id="&#x5B9E;&#x73B0;&#x81EA;&#x5B9A;&#x4E49;&#x6570;&#x636E;&#x6C47;&#x51FD;&#x6570;">&#x5B9E;&#x73B0;&#x81EA;&#x5B9A;&#x4E49;&#x6570;&#x636E;&#x6C47;&#x51FD;&#x6570;</h2>
<ul>
<li>SinkFunction.invoke(value: IN, ctx: Context)&#xFF1A;e.g. &#x5957;&#x63A5;&#x5B57;</li>
<li>&#x5E42;&#x7B49;&#x6027;&#x6570;&#x636E;&#x6C47;&#x8FDE;&#x63A5;&#x5668;&#xFF1A;e.g. Derby</li>
<li><p>&#x4E8B;&#x52A1;&#x6027;&#x6570;&#x636E;&#x6C47;&#x8FDE;&#x63A5;&#x5668;&#xFF1A;&#x5B9E;&#x73B0; CheckpointListener &#x63A5;&#x53E3;</p>
<ul>
<li>GennericWriteAheadSink&#xFF1A;&#x81F3;&#x5C11;&#x4E00;&#x6B21;<ul>
<li>&#x53C2;&#x6570;&#xFF1A;CheckopintCommiter, TypeSerializer, &#x4EFB;&#x52A1;id</li>
<li>&#x65B9;&#x6CD5;&#xFF1A;boolean sendValues(Iterable\<in> values, long chkpntId, long timestamp)</in></li>
</ul>
</li>
<li>TwoPhaseCommitSinkFunction&#xFF1A;&#x7CBE;&#x786E;&#x4E00;&#x6B21;<ul>
<li>&#x8981;&#x6C42;<ul>
<li>&#x5916;&#x90E8;&#x6570;&#x636E;&#x6C47;&#x652F;&#x6301;&#x4E8B;&#x52A1;&#x3001;&#x68C0;&#x67E5;&#x70B9;&#x95F4;&#x9694;&#x671F;&#x4E8B;&#x52A1;&#x5F00;&#x542F;&#x3001;&#x4E8B;&#x52A1;&#x63A5;&#x5230;&#x5B8C;&#x6210;&#x901A;&#x77E5;&#x540E;&#x63D0;&#x4EA4;</li>
<li>&#x6570;&#x636E;&#x6C47;&#x9700;&#x8981;&#x5728;&#x8FDB;&#x7A0B;&#x6545;&#x969C;&#x65F6;&#x8FDB;&#x884C;&#x4E8B;&#x52A1;&#x6062;&#x590D;&#x3001;&#x63D0;&#x4EA4;&#x4E8B;&#x52A1;&#x7684;&#x64CD;&#x4F5C;&#x662F;&#x5E42;&#x7B49;&#x7684;</li>
</ul>
</li>
<li>&#x65B9;&#x6CD5;&#xFF1A;<ul>
<li>beginTransaction()</li>
<li>invoke(txn: TXN, value: IN, context: Context[_])</li>
<li>preCommit(txn: TXN)&#x3001;commit(txn: TXN)</li>
<li>abort(txn: TXN)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>SinkFunction</strong></p>
</li>
</ul>
<pre><code class="lang-scala"><span class="hljs-comment">// nc -l localhost 9091</span>
<span class="hljs-comment">// write the sensor readings to a socket</span>
<span class="hljs-keyword">val</span> reading: <span class="hljs-type">DataStream</span>[<span class="hljs-type">SensorReading</span>] = ...
readings.addSink(<span class="hljs-keyword">new</span> <span class="hljs-type">SimpleSocketSink</span>(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">9191</span>).setParallelism(<span class="hljs-number">1</span>)

<span class="hljs-comment">// Writes a stream of [[SensorReading]] to a socket.</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleSocketSink</span>(<span class="hljs-params">val host: <span class="hljs-type">String</span>, val port: <span class="hljs-type">Int</span></span>)</span>
    <span class="hljs-keyword">extends</span> <span class="hljs-type">RichSinkFunction</span>[<span class="hljs-type">SensorReading</span>] {

  <span class="hljs-keyword">var</span> socket: <span class="hljs-type">Socket</span> = _
  <span class="hljs-keyword">var</span> writer: <span class="hljs-type">PrintStream</span> = _

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">open</span></span>(config: <span class="hljs-type">Configuration</span>): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// open socket and writer</span>
    socket = <span class="hljs-keyword">new</span> <span class="hljs-type">Socket</span>(<span class="hljs-type">InetAddress</span>.getByName(host), port)
    writer = <span class="hljs-keyword">new</span> <span class="hljs-type">PrintStream</span>(socket.getOutputStream)
  }

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">invoke</span></span>(
      value: <span class="hljs-type">SensorReading</span>,
      ctx: <span class="hljs-type">SinkFunction</span>.<span class="hljs-type">Context</span>[_]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// write sensor reading to socket</span>
    writer.println(value.toString)
    writer.flush()
  }

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">close</span></span>(): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// close writer and socket</span>
    writer.close()
    socket.close()
  }
}
</code></pre>
<ul>
<li><strong>IdempotentSinkFunction</strong></li>
</ul>
<pre><code class="lang-scala"><span class="hljs-comment">// write the converted sensor readings to Derby.</span>
<span class="hljs-keyword">val</span> reading: <span class="hljs-type">DataStream</span>[<span class="hljs-type">SensorReading</span>] = ...
readings.addSink(<span class="hljs-keyword">new</span> <span class="hljs-type">DerbyUpsertSink</span>)

<span class="hljs-comment">// Sink that upserts SensorReadings into a Derby table</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DerbyUpsertSink</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RichSinkFunction</span>[<span class="hljs-type">SensorReading</span>] </span>{

  <span class="hljs-keyword">var</span> conn: <span class="hljs-type">Connection</span> = _
  <span class="hljs-keyword">var</span> insertStmt: <span class="hljs-type">PreparedStatement</span> = _
  <span class="hljs-keyword">var</span> updateStmt: <span class="hljs-type">PreparedStatement</span> = _

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">open</span></span>(parameters: <span class="hljs-type">Configuration</span>): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// connect to embedded in-memory Derby</span>
    <span class="hljs-keyword">val</span> props = <span class="hljs-keyword">new</span> <span class="hljs-type">Properties</span>()
    conn = <span class="hljs-type">DriverManager</span>.getConnection(<span class="hljs-string">&quot;jdbc:derby:memory:flinkExample&quot;</span>, props)
    <span class="hljs-comment">// prepare insert and update statements</span>
    insertStmt = conn.prepareStatement(
      <span class="hljs-string">&quot;INSERT INTO Temperatures (sensor, temp) VALUES (?, ?)&quot;</span>)
    updateStmt = conn.prepareStatement(
      <span class="hljs-string">&quot;UPDATE Temperatures SET temp = ? WHERE sensor = ?&quot;</span>)
  }

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">invoke</span></span>(r: <span class="hljs-type">SensorReading</span>, context: <span class="hljs-type">Context</span>[_]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// set parameters for update statement and execute it</span>
    updateStmt.setDouble(<span class="hljs-number">1</span>, r.temperature)
    updateStmt.setString(<span class="hljs-number">2</span>, r.id)
    updateStmt.execute()
    <span class="hljs-comment">// execute insert statement if update statement did not update any row</span>
    <span class="hljs-keyword">if</span> (updateStmt.getUpdateCount == <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// set parameters for insert statement</span>
      insertStmt.setString(<span class="hljs-number">1</span>, r.id)
      insertStmt.setDouble(<span class="hljs-number">2</span>, r.temperature)
      <span class="hljs-comment">// execute insert statement</span>
      insertStmt.execute()
    }
  }

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">close</span></span>(): <span class="hljs-type">Unit</span> = {
    insertStmt.close()
    updateStmt.close()
    conn.close()
  }
}
</code></pre>
<ul>
<li><strong>WAL</strong></li>
</ul>
<pre><code class="lang-scala"><span class="hljs-comment">// print to standard out with a write-ahead log.</span>
<span class="hljs-comment">// results are printed when a checkpoint is completed.</span>
<span class="hljs-keyword">val</span> readings: <span class="hljs-type">DataStream</span>[<span class="hljs-type">SensorReading</span>] = ...
readings.transform(<span class="hljs-string">&quot;WriteAheadSink&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">StdOutWriteAheadSink</span>).setParallelism(<span class="hljs-number">1</span>)

<span class="hljs-comment">// Write-ahead sink that prints to standard out and</span>
<span class="hljs-comment">// commits checkpoints to the local file system.</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StdOutWriteAheadSink</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericWriteAheadSink</span>[(<span class="hljs-type">String</span>, <span class="hljs-type">Double</span>)](<span class="hljs-params">
    // <span class="hljs-type">CheckpointCommitter</span> that commits checkpoints to the local file system
    new <span class="hljs-type">FileCheckpointCommitter</span>(<span class="hljs-type">System</span>.getProperty(&quot;java.io.tmpdir&quot;</span>)),</span>
    <span class="hljs-comment">// Serializer for records</span>
    createTypeInformation[(<span class="hljs-type">String</span>, <span class="hljs-type">Double</span>)].createSerializer(<span class="hljs-keyword">new</span> <span class="hljs-type">ExecutionConfig</span>),
    <span class="hljs-comment">// Random JobID used by the CheckpointCommitter</span>
    <span class="hljs-type">UUID</span>.randomUUID.toString) {

  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sendValues</span></span>(
      readings: <span class="hljs-type">Iterable</span>[(<span class="hljs-type">String</span>, <span class="hljs-type">Double</span>)],
      checkpointId: <span class="hljs-type">Long</span>,
      timestamp: <span class="hljs-type">Long</span>): <span class="hljs-type">Boolean</span> = {

    <span class="hljs-keyword">for</span> (r &lt;- readings.asScala) {
      <span class="hljs-comment">// write record to standard out</span>
      println(r)
    }
    <span class="hljs-literal">true</span>
  }
}
</code></pre>
<ul>
<li><strong>2PC</strong></li>
</ul>
<pre><code class="lang-scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransactionalFileSink</span>(<span class="hljs-params">val targetPath: <span class="hljs-type">String</span>, val tempPath: <span class="hljs-type">String</span></span>)</span>
    <span class="hljs-keyword">extends</span> <span class="hljs-type">TwoPhaseCommitSinkFunction</span>[(<span class="hljs-type">String</span>, <span class="hljs-type">Double</span>), <span class="hljs-type">String</span>, <span class="hljs-type">Void</span>](
      createTypeInformation[<span class="hljs-type">String</span>].createSerializer(<span class="hljs-keyword">new</span> <span class="hljs-type">ExecutionConfig</span>),
      createTypeInformation[<span class="hljs-type">Void</span>].createSerializer(<span class="hljs-keyword">new</span> <span class="hljs-type">ExecutionConfig</span>)) {

  <span class="hljs-keyword">var</span> transactionWriter: <span class="hljs-type">BufferedWriter</span> = _

  <span class="hljs-comment">/** Creates a temporary file for a transaction into which the records are
    * written.
    */</span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">beginTransaction</span></span>(): <span class="hljs-type">String</span> = {

    <span class="hljs-comment">// path of transaction file is constructed from current time and task index</span>
    <span class="hljs-keyword">val</span> timeNow = <span class="hljs-type">LocalDateTime</span>.now(<span class="hljs-type">ZoneId</span>.of(<span class="hljs-string">&quot;UTC&quot;</span>))
      .format(<span class="hljs-type">DateTimeFormatter</span>.<span class="hljs-type">ISO_LOCAL_DATE_TIME</span>)
    <span class="hljs-keyword">val</span> taskIdx = <span class="hljs-keyword">this</span>.getRuntimeContext.getIndexOfThisSubtask
    <span class="hljs-keyword">val</span> transactionFile = <span class="hljs-string">s&quot;<span class="hljs-subst">$timeNow</span>-<span class="hljs-subst">$taskIdx</span>&quot;</span>

    <span class="hljs-comment">// create transaction file and writer</span>
    <span class="hljs-keyword">val</span> tFilePath = <span class="hljs-type">Paths</span>.get(<span class="hljs-string">s&quot;<span class="hljs-subst">$tempPath</span>/<span class="hljs-subst">$transactionFile</span>&quot;</span>)
    <span class="hljs-type">Files</span>.createFile(tFilePath)
    <span class="hljs-keyword">this</span>.transactionWriter = <span class="hljs-type">Files</span>.newBufferedWriter(tFilePath)
    println(<span class="hljs-string">s&quot;Creating Transaction File: <span class="hljs-subst">$tFilePath</span>&quot;</span>)

    <span class="hljs-comment">// name of transaction file is returned to later identify the transaction</span>
    transactionFile
  }

  <span class="hljs-comment">/** Write record into the current transaction file. */</span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">invoke</span></span>(transaction: <span class="hljs-type">String</span>, value: (<span class="hljs-type">String</span>, <span class="hljs-type">Double</span>),
    context: <span class="hljs-type">Context</span>[_]): <span class="hljs-type">Unit</span> = {

    transactionWriter.write(value.toString)
    transactionWriter.write(&apos;\n&apos;)
  }

  <span class="hljs-comment">/** Flush and close the current transaction file. */</span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">preCommit</span></span>(transaction: <span class="hljs-type">String</span>): <span class="hljs-type">Unit</span> = {
    transactionWriter.flush()
    transactionWriter.close()
  }

  <span class="hljs-comment">/** Commit a transaction by moving the pre-committed transaction file
    * to the target directory.
    */</span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">commit</span></span>(transaction: <span class="hljs-type">String</span>): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> tFilePath = <span class="hljs-type">Paths</span>.get(<span class="hljs-string">s&quot;<span class="hljs-subst">$tempPath</span>/<span class="hljs-subst">$transaction</span>&quot;</span>)
    <span class="hljs-comment">// check if the file exists to ensure that the commit is idempotent.</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-type">Files</span>.exists(tFilePath)) {
      <span class="hljs-keyword">val</span> cFilePath = <span class="hljs-type">Paths</span>.get(<span class="hljs-string">s&quot;<span class="hljs-subst">$targetPath</span>/<span class="hljs-subst">$transaction</span>&quot;</span>)
      <span class="hljs-type">Files</span>.move(tFilePath, cFilePath)
    }
  }

  <span class="hljs-comment">/** Aborts a transaction by deleting the transaction file. */</span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">abort</span></span>(transaction: <span class="hljs-type">String</span>): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> tFilePath = <span class="hljs-type">Paths</span>.get(<span class="hljs-string">s&quot;<span class="hljs-subst">$tempPath</span>/<span class="hljs-subst">$transaction</span>&quot;</span>)
    <span class="hljs-keyword">if</span> (<span class="hljs-type">Files</span>.exists(tFilePath)) {
      <span class="hljs-type">Files</span>.delete(tFilePath)
    }
  }
}
</code></pre>
<h2 id="&#x5F02;&#x6B65;&#x8BBF;&#x95EE;&#x5916;&#x90E8;&#x7CFB;&#x7EDF;">&#x5F02;&#x6B65;&#x8BBF;&#x95EE;&#x5916;&#x90E8;&#x7CFB;&#x7EDF;</h2>
<ul>
<li>AsyncFunction<ul>
<li>orderedWait()&#xFF1A;&#x6309;&#x7167;&#x6570;&#x636E;&#x8BB0;&#x5F55;&#x987A;&#x5E8F;&#x53D1;&#x51FA;&#x7ED3;&#x679C;&#x7684;&#x5F02;&#x6B65;&#x7B97;&#x5B50;</li>
<li>unorderedWait()&#xFF1A;&#x53EA;&#x80FD;&#x8BA9;&#x6C34;&#x4F4D;&#x7EBF;&#x548C;&#x68C0;&#x67E5;&#x70B9;&#x5206;&#x9694;&#x7B26;&#x4FDD;&#x6301;&#x5BF9;&#x9F50;</li>
</ul>
</li>
<li><p>&#x793A;&#x4F8B;&#x4E2D;&#x4E3A;&#x6BCF;&#x6761;&#x8BB0;&#x5F55;&#x521B;&#x5EFA; JDBC &#x8FDE;&#x63A5;&#xFF0C;&#x5B9E;&#x9645;&#x5E94;&#x7528;&#x4E2D;&#x9700;&#x8981;&#x907F;&#x514D;</p>
</li>
<li><p><strong>orderedWait</strong></p>
</li>
</ul>
<pre><code class="lang-scala"><span class="hljs-comment">// look up the location of a sensor from a Derby table with asynchronous requests.</span>
<span class="hljs-keyword">val</span> readings: <span class="hljs-type">DataStream</span>[<span class="hljs-type">SensorReading</span>] = ...
<span class="hljs-keyword">val</span> sensorLocations: <span class="hljs-type">DataStream</span>[(<span class="hljs-type">String</span>, <span class="hljs-type">String</span>)] = <span class="hljs-type">AsyncDataStream</span>
  .orderedWait(
    readings,
    <span class="hljs-keyword">new</span> <span class="hljs-type">DerbyAsyncFunction</span>,
    <span class="hljs-number">5</span>, <span class="hljs-type">TimeUnit</span>.<span class="hljs-type">SECONDS</span>,        <span class="hljs-comment">// timeout requests after 5 seconds</span>
    <span class="hljs-number">100</span>)                        <span class="hljs-comment">// at most 100 concurrent requests</span>
</code></pre>
<ul>
<li><strong>DerbyAsyncFunction</strong></li>
</ul>
<pre><code class="lang-scala"><span class="hljs-comment">// AsyncFunction that queries a Derby table via JDBC in a non-blocking fashion.</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DerbyAsyncFunction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AsyncFunction</span>[<span class="hljs-type">SensorReading</span>, (<span class="hljs-type">String</span>, <span class="hljs-type">String</span>)] </span>{

  <span class="hljs-comment">// caching execution context used to handle the query threads</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">lazy</span> <span class="hljs-keyword">val</span> cachingPoolExecCtx =
    <span class="hljs-type">ExecutionContext</span>.fromExecutor(<span class="hljs-type">Executors</span>.newCachedThreadPool())
  <span class="hljs-comment">// direct execution context to forward result future to callback object</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">lazy</span> <span class="hljs-keyword">val</span> directExecCtx =
    <span class="hljs-type">ExecutionContext</span>.fromExecutor(
      org.apache.flink.runtime.concurrent.<span class="hljs-type">Executors</span>.directExecutor())

  <span class="hljs-comment">/** Executes JDBC query in a thread and handles the resulting Future
    * with an asynchronous callback. */</span>
  <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">asyncInvoke</span></span>(
      reading: <span class="hljs-type">SensorReading</span>,
      resultFuture: <span class="hljs-type">ResultFuture</span>[(<span class="hljs-type">String</span>, <span class="hljs-type">String</span>)]): <span class="hljs-type">Unit</span> = {

    <span class="hljs-keyword">val</span> sensor = reading.id

    <span class="hljs-comment">// get room from Derby table as Future</span>
    <span class="hljs-keyword">val</span> room: <span class="hljs-type">Future</span>[<span class="hljs-type">String</span>] = <span class="hljs-type">Future</span> {
      <span class="hljs-comment">// Creating a new connection and statement for each record.</span>
      <span class="hljs-comment">// Note: This is NOT best practice!</span>
      <span class="hljs-comment">// Connections and prepared statements should be cached.</span>
      <span class="hljs-keyword">val</span> conn = <span class="hljs-type">DriverManager</span>
        .getConnection(<span class="hljs-string">&quot;jdbc:derby:memory:flinkExample&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">Properties</span>())
      <span class="hljs-keyword">val</span> query = conn.createStatement()

      <span class="hljs-comment">// submit query and wait for result. this is a synchronous call.</span>
      <span class="hljs-keyword">val</span> result = query.executeQuery(
        <span class="hljs-string">s&quot;SELECT room FROM SensorLocations WHERE sensor = &apos;<span class="hljs-subst">$sensor</span>&apos;&quot;</span>)

      <span class="hljs-comment">// get room if there is one</span>
      <span class="hljs-keyword">val</span> room = <span class="hljs-keyword">if</span> (result.next()) {
        result.getString(<span class="hljs-number">1</span>)
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-string">&quot;UNKNOWN ROOM&quot;</span>
      }

      <span class="hljs-comment">// close resultset, statement, and connection</span>
      result.close()
      query.close()
      conn.close()

      <span class="hljs-comment">// sleep to simulate (very) slow requests</span>
      <span class="hljs-type">Thread</span>.sleep(<span class="hljs-number">2000</span>L)

      <span class="hljs-comment">// return room</span>
      room
    }(cachingPoolExecCtx)

    <span class="hljs-comment">// apply result handling callback on the room future</span>
    room.onComplete {
      <span class="hljs-keyword">case</span> <span class="hljs-type">Success</span>(r) =&gt; resultFuture.complete(<span class="hljs-type">Seq</span>((sensor, r)))
      <span class="hljs-keyword">case</span> <span class="hljs-type">Failure</span>(e) =&gt; resultFuture.completeExceptionally(e)
    }(directExecCtx)
  }
}
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="chap7.html" class="navigation navigation-prev " aria-label="Previous page: 7. 有状态算子和应用">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="chap9.html" class="navigation navigation-next " aria-label="Next page: 9. 搭建 Flink 运行流式应用">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"8. 读写外部系统","level":"1.9","depth":1,"next":{"title":"9. 搭建 Flink 运行流式应用","level":"1.10","depth":1,"path":"chap9.md","ref":"chap9.md","articles":[]},"previous":{"title":"7. 有状态算子和应用","level":"1.8","depth":1,"path":"chap7.md","ref":"chap7.md","articles":[]},"dir":"ltr"},"config":{"plugins":[],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"杨镓毓","pdf":{"pageBreaksBefore":"/","headerTemplate":null,"paperSize":"a4","margin":{"right":0,"left":0,"top":0,"bottom":0},"fontSize":12,"fontFamily":"Arial","footerTemplate":null,"chapterMark":"pagebreak","pageNumbers":true},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"基于 Apache Flink 的流处理","links":{"sharing":{"all":null,"facebook":null,"google":null,"twitter":null,"weibo":null}},"gitbook":"*","description":"《基于 Apache Flink 的流处理》书籍笔记","extension":null},"file":{"path":"chap8.md","mtime":"2022-02-26T08:37:33.301Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-02-26T09:25:21.828Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

